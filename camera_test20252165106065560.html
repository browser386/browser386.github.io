<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>后置摄像头对比</title>
  <style>
    body { font-family: sans-serif; background: #f5f5f5; text-align: center; }
    h2 { margin-top: 20px; }
    table { border-collapse: collapse; margin: 20px auto; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px 12px; }
    th { background: #eee; }
    video { width: 90%; max-width: 600px; margin-top: 20px; border: 2px solid #333; border-radius: 8px; background: black; }
    tr:hover { background: #f0f0f0; cursor: pointer; }
  </style>
</head>
<body>
  <h2>所有后置摄像头分辨率对比</h2>
  <table id="results">
    <tr><th>设备名</th><th>方向</th><th>分辨率</th></tr>
  </table>
  <!-- 加上 muted，确保自动播放 -->
  <video id="video" autoplay playsinline muted></video>

  <script>
    const table = document.getElementById("results");
    const video = document.getElementById("video");
    let currentStream = null;

    async function playStream(stream) {
      if (currentStream) {
        currentStream.getTracks().forEach(t => t.stop());
      }
      currentStream = stream;
      video.srcObject = stream;
      try {
        await video.play();
      } catch (err) {
        console.warn("自动播放失败，需要用户点击触发:", err);
      }
    }

    // 测试单个摄像头
    async function testCamera(device) {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { deviceId: { exact: device.deviceId } }
        });
        const track = stream.getVideoTracks()[0];
        const settings = track.getSettings();
        const { width, height, facingMode } = settings;

        stream.getTracks().forEach(t => t.stop());

        return {
          label: device.label || "未命名",
          deviceId: device.deviceId,
          facingMode: facingMode || "unknown",
          width: width || 0,
          height: height || 0
        };
      } catch {
        return null;
      }
    }

    // 在页面显示结果
    function addRow(info) {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${info.label}</td>
        <td>${info.facingMode}</td>
        <td>${info.width} x ${info.height}</td>
      `;
      row.addEventListener("click", () => showCamera(info.deviceId));
      table.appendChild(row);
    }

    // 打开某个摄像头预览
    async function showCamera(deviceId) {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { deviceId: { exact: deviceId } }
      });
      await playStream(stream);
    }

    // 打开默认后置摄像头
    async function showDefaultBackCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" }
        });
        await playStream(stream);
      } catch (e) {
        console.error("打开默认后置相机失败:", e);
        const fallback = await navigator.mediaDevices.getUserMedia({ video: true });
        await playStream(fallback);
      }
    }

    // 初始化
    async function init() {
      // 先打开默认后置摄像头
      await showDefaultBackCamera();

      // 获取权限，让 label 可见
      await navigator.mediaDevices.getUserMedia({ video: true });

      const devices = await navigator.mediaDevices.enumerateDevices();
      const cameras = devices.filter(d => d.kind === "videoinput");

      let backCams = [];
      for (const cam of cameras) {
        const info = await testCamera(cam);
        if (info && info.facingMode === "environment") {
          backCams.push(info);
        }
      }

      if (backCams.length === 0) {
        const row = document.createElement("tr");
        row.innerHTML = `<td colspan="3">未检测到后置相机</td>`;
        table.appendChild(row);
        return;
      }

      // 添加表格行
      for (const cam of backCams) {
        addRow(cam);
      }
    }

    init();
  </script>
</body>
</html>
